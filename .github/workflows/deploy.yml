name: Deploy Legal Engine
on:
  push:
    branches: [ "main" ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with: { node-version: '18' }
    
    # Build TypeScript
    - run: npm install && npm run package
    
    # Deploy Infra
    - uses: hashicorp/setup-terraform@v2
    - name: Terraform Apply
      working-directory: ./terraform
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        TF_VAR_llama_cloud_key: ${{ secrets.LLAMA_CLOUD_KEY }}
        TF_VAR_supabase_url: ${{ secrets.SUPABASE_URL }}
        TF_VAR_supabase_key: ${{ secrets.SUPABASE_KEY }}
        TF_VAR_openai_vector_store_id: ${{ secrets.VECTOR_STORE_ID }}
        TF_VAR_openai_assistant_id: ${{ secrets.ASSISTANT_ID }}
      run: terraform init && terraform apply -auto-approve

